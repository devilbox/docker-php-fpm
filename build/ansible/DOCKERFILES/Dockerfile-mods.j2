{{ edit_comment_mods }}
FROM devilbox/php-fpm:{{ php_version }}-base as builder


#ADD https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions /usr/local/bin/
COPY --from=mlocati/php-extension-installer /usr/bin/install-php-extensions /usr/local/bin/
#COPY ./data/install-php-extensions /usr/local/bin/

RUN chmod uga+x /usr/local/bin/install-php-extensions && sync

{#
###################################################################################################
  Loop over enabled build dependencies and gather build dependencies
###################################################################################################
#}
{% if extensions_enabled|length > 0 %}
    {#
    # Deactive PSR and Phalcon:
    # https://github.com/devilbox/docker-php-fpm/issues/201
    #}
    {%- set ext_deactivated = ['psr', 'phalcon'] -%}

    {%- for ext in extensions_enabled -%}
        {%- if (ext not in extensions_available) -%}
            {# cannot install this ext module, if not declared #}
        {%- else -%}
            {%- if (
                (ext not in ext_deactivated)
                and ('disabled' not in extensions_available[ext] or php_version not in extensions_available[ext]['disabled'])
                and ('already_avail' not in extensions_available[ext] or php_version not in extensions_available[ext]['already_avail'])
            ) -%}
{{- "\n" }}RUN install-php-extensions {{ ext }}{%- if php_version in extensions_available[ext] and 'version' in extensions_available[ext][php_version] -%}-{{ extensions_available[ext][php_version]['version'] }}{%- endif %}
            {%- endif %}
        {%- endif %}
    {%- endfor -%}
{% endif %}


###
### Labels
###
# https://github.com/opencontainers/image-spec/blob/master/annotations.md
#LABEL "org.opencontainers.image.created"=""
#LABEL "org.opencontainers.image.version"=""
#LABEL "org.opencontainers.image.revision"=""
LABEL "maintainer"="cytopia <cytopia@everythingcli.org>"
LABEL "org.opencontainers.image.authors"="cytopia <cytopia@everythingcli.org>"
LABEL "org.opencontainers.image.url"="https://github.com/devilbox/docker-php-fpm"
LABEL "org.opencontainers.image.documentation"="https://github.com/devilbox/docker-php-fpm"
LABEL "org.opencontainers.image.source"="https://github.com/devilbox/docker-php-fpm"
LABEL "org.opencontainers.image.vendor"="devilbox"
LABEL "org.opencontainers.image.licenses"="MIT"
LABEL "org.opencontainers.image.ref.name"="{{ php_version }}-mods"
LABEL "org.opencontainers.image.title"="PHP-FPM {{ php_version }}-mods"
LABEL "org.opencontainers.image.description"="PHP-FPM {{ php_version }}-mods"


###
### Ports
###
EXPOSE 9000


###
### Entrypoint
###
CMD ["/usr/local/sbin/php-fpm"]
ENTRYPOINT ["/docker-entrypoint.sh"]
