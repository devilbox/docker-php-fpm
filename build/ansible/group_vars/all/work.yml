---
###################################################################################################
# Docker: work
###################################################################################################

#
# This file holds definition for all devibox/php-fpm:x.y-work images
#


###
### Define operating system versions
###
os_release:
  # Jessie (Ubuntu: trusty, utopic, vivid, wily)
  5.2:
    debian: jessie
    ubuntu: trusty
  5.3:
    debian: jessie
    ubuntu: trusty
  5.4:
    debian: jessie
    ubuntu: trusty
  5.5:
    debian: jessie
    ubuntu: trusty
  # Strech (Ubuntu: xenial, yakkety, zesty, artful)
  5.6:
    debian: stretch
    ubuntu: xenial
  7.0:
    debian: stretch
    ubuntu: xenial
  # Buster (Ubuntu: bionic, cosmic, disco, eoan)
  7.1:
    debian: buster
    ubuntu: bionic
  7.2:
    debian: buster
    ubuntu: bionic
  # Bullseye (Ubuntu: focal, groovy, hirsute, impish)
  7.3:
    debian: bullseye
    ubuntu: focal
  7.4:
    debian: bullseye
    ubuntu: focal
  8.0:
    debian: bullseye
    ubuntu: focal
  8.1:
    debian: bullseye
    ubuntu: focal
  8.2:
    debian: bullseye
    ubuntu: focal
  all:
    debian: bullseye
    ubuntu: focal


# -------------------------------------------------------------------------------------------------
# Global variables
# -------------------------------------------------------------------------------------------------
composer_home: /usr/local/src/composer
nvm_home: /opt/nvm
node_version: --lts

directory_to_clean:
  - .*json
  - .ansible
  - .cache
  - .composer
  - .config
  - .console
  - .drush
  - .gem
  - .local
  - .node
  - .npm
  - .pm2
  - .subversion
  - .v8*
  - node_modules
  - yarn.lock


# -------------------------------------------------------------------------------------------------
# Apt repositories to enable (in defined order)
# -------------------------------------------------------------------------------------------------
apt_repositories_enabled:
  - backports
  - blackfire
  #- git
  #- mongo
  #- pgsql


# -------------------------------------------------------------------------------------------------
# PHP Composer packages to install
# -------------------------------------------------------------------------------------------------
composer_enabled:
  - asgardcms
  - codeception
  - lumen
  #- photon
  - prestissimo


# -------------------------------------------------------------------------------------------------
# Ruby gem packages to install
# -------------------------------------------------------------------------------------------------
gem_enabled:
  - mixlib_config
  - ffi
  - rb_inotify
  - mdl


# -------------------------------------------------------------------------------------------------
# Node npm packages to install
# -------------------------------------------------------------------------------------------------
npm_enabled:
  - angular_cli
  - eslint
  - grunt
  - grunt_cli
  - gulp
  - jsonlint
  # https://github.com/Unitech/pm2
  - pm2
  - mdlint
  - sass
  - stylelint
  - vue_cli
  - vue_cli_service_global
  - webpack
  - webpack_cli


# -------------------------------------------------------------------------------------------------
# Python pip packages to install
# -------------------------------------------------------------------------------------------------
pip_enabled:
  #- ansible
  - yamllint
  - yq


# -------------------------------------------------------------------------------------------------
# Software to install (in defined order)
# -------------------------------------------------------------------------------------------------
software_enabled:
  # Composer, pip and nvm need to be first, others rely on it
  - composer
  - pip
  - nvm
  # Required for internal Devilbox connection
  - pgsql_client
  - mongo_client
  # Normal packages start here
  - awesomeci
  - deployer
  - drush7
  - drush8
  - drush9
  - drupalconsole
  - gitflow
  #- homebrew
  - laravel
  - linkcheck
  - mhsendmail
  - mysqldumpsecure
  - phalcon
  - phpcs
  - phpcbf
  - php-cs-fixer
  - phpmd
  - phpunit
  - symfony
  - wkhtmltopdf
  - wpcli


# -------------------------------------------------------------------------------------------------
# Apt repository definition
# -------------------------------------------------------------------------------------------------

# all: is generic version of defines
# 7.2: is specific version of defines
# disabled: [optional] Array of PHP versions for which to disable this module
#
# all, 7.2, 7.1, 7.0, 5.6, 5.5, 5.4:
#   deb:       Deb line to add to sources list
#   key:       [optional] Key id to add for repository
#   pre:       [optional] Run custom command to add gpg key for repository
#
apt_repositories_available:
  ###
  ### Backports
  ###
  backports:
    # [Jessie]
    5.2:
      pre: echo 'Acquire::Check-Valid-Until no;' > /etc/apt/apt.conf.d/99no-check-valid-until
      deb: deb [trusted=yes] http://archive.debian.org/debian {{ os_release[5.2].debian }}-backports main
    # [Jessie]
    5.3:
      pre: echo 'Acquire::Check-Valid-Until no;' > /etc/apt/apt.conf.d/99no-check-valid-until
      deb: deb [trusted=yes] http://archive.debian.org/debian {{ os_release[5.3].debian }}-backports main
    # [Jessie]
    5.4:
      pre: echo 'Acquire::Check-Valid-Until no;' > /etc/apt/apt.conf.d/99no-check-valid-until
      deb: deb [trusted=yes] http://archive.debian.org/debian {{ os_release[5.4].debian }}-backports main
    # [Jessie]
    5.5:
      pre: echo 'Acquire::Check-Valid-Until no;' > /etc/apt/apt.conf.d/99no-check-valid-until
      deb: deb [trusted=yes] http://archive.debian.org/debian {{ os_release[5.5].debian }}-backports main
    # [Stretch]
    5.6:
      pre: apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 648ACFD622F3D138
      deb: deb http://ftp.debian.org/debian {{ os_release[5.6].debian }}-backports main
    # [Stretch]
    7.0:
      pre: apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 648ACFD622F3D138
      deb: deb http://ftp.debian.org/debian {{ os_release[7.0].debian }}-backports main
    # [Buster]
    7.1:
      pre: apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 648ACFD622F3D138
      deb: deb http://ftp.debian.org/debian {{ os_release[7.1].debian }}-backports main
    # [Buster]
    7.2:
      pre: apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 648ACFD622F3D138
      deb: deb http://ftp.debian.org/debian {{ os_release[7.2].debian }}-backports main
    # [Bullseye]
    all:
      pre: apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 648ACFD622F3D138
      deb: deb http://ftp.debian.org/debian {{ os_release['all'].debian }}-backports main
  ###
  ### Blackfire
  ###
  blackfire:
    all:
      deb: deb http://packages.blackfire.io/debian any main
      pre: curl -sS -L --fail "https://packages.blackfire.io/gpg.key" | APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1 apt-key add -
  ###
  ### Git (currently obsolete)
  ###
  git:
    5.2:
      deb: deb http://ppa.launchpad.net/git-core/ppa/ubuntu {{ os_release[5.2].ubuntu }} main
    5.3:
      deb: deb http://ppa.launchpad.net/git-core/ppa/ubuntu {{ os_release[5.3].ubuntu }} main
    5.4:
      deb: deb http://ppa.launchpad.net/git-core/ppa/ubuntu {{ os_release[5.4].ubuntu }} main
    5.5:
      deb: deb http://ppa.launchpad.net/git-core/ppa/ubuntu {{ os_release[5.5].ubuntu }} main
    5.6:
      deb: deb http://ppa.launchpad.net/git-core/ppa/ubuntu {{ os_release[5.6].ubuntu }} main
    7.0:
      deb: deb http://ppa.launchpad.net/git-core/ppa/ubuntu {{ os_release[7.0].ubuntu }} main
    7.1:
      deb: deb http://ppa.launchpad.net/git-core/ppa/ubuntu {{ os_release[7.1].ubuntu }} main
    7.2:
      deb: deb http://ppa.launchpad.net/git-core/ppa/ubuntu {{ os_release[7.2].ubuntu }} main
    7.3:
      deb: deb http://ppa.launchpad.net/git-core/ppa/ubuntu {{ os_release[7.3].ubuntu }} main
    7.4:
      deb: deb http://ppa.launchpad.net/git-core/ppa/ubuntu {{ os_release[7.4].ubuntu }} main
    8.0:
      deb: deb http://ppa.launchpad.net/git-core/ppa/ubuntu {{ os_release[8.0].ubuntu }} main
    8.1:
      deb: deb http://ppa.launchpad.net/git-core/ppa/ubuntu {{ os_release[8.1].ubuntu }} main
    8.2:
      deb: deb http://ppa.launchpad.net/git-core/ppa/ubuntu {{ os_release[8.2].ubuntu }} main
    all:
      key: A1715D88E1DF1F24
  ###
  ### MongoDB (currently obsolete)
  ###
  mongo:
    # 5.2: mongodb-clients (amd64)
    # 5.3: mongodb-clients (amd64)
    # 5.4: mongodb-clients (amd64)
    # 5.5: mongodb-clients (amd64)
    # 5.6: mongodb-clients & mongo-tools (amd64, arm64)
    # 7.0: mongodb-clients & mongo-tools (amd64, arm64)
    # 7.1: mongo-tools OR mongodb-org-(tools|shell) (amd64, arm64)
    # 7.2: mongo-tools OR mongodb-org-(tools|shell) (amd64, arm64)
    # 7.3: mongodb-org-(tools|shell) (amd64, arm64)
    # 7.4: mongodb-org-(tools|shell) (amd64, arm64)
    # 8.0: mongodb-org-(tools|shell) (amd64, arm64)
    # 8.1: mongodb-org-(tools|shell) (amd64, arm64)
    # 8.2: mongodb-org-(tools|shell) (amd64, arm64)
    disabled: [5.2, 5.3, 5.4, 5.5, 5.6, 7.0]
    # [Buster] Ubuntu repository required for arm64 support instead
    7.1:
      # gpg --dry-run --with-fingerprint < <(curl https://www.mongodb.org/static/pgp/server-4.4.asc) | grep fingerprint | sed 's/.*=//g' | sed 's/ //g'
      deb: deb http://repo.mongodb.org/apt/ubuntu {{ os_release[7.1].ubuntu }}/mongodb-org/4.4 multiverse
      key: 20691EEC35216C63CAF66CE1656408E390CFB1F5
    # [Buster] Ubuntu repository required for arm64 support instead
    7.2:
      # gpg --dry-run --with-fingerprint < <(curl https://www.mongodb.org/static/pgp/server-4.4.asc) | grep fingerprint | sed 's/.*=//g' | sed 's/ //g'
      deb: deb http://repo.mongodb.org/apt/ubuntu {{ os_release[7.2].ubuntu }}/mongodb-org/4.4 multiverse
      key: 20691EEC35216C63CAF66CE1656408E390CFB1F5
    # [Bullseye] Ubuntu repository required for arm64 support instead
    all:
      # gpg --dry-run --with-fingerprint < <(curl https://www.mongodb.org/static/pgp/server-4.4.asc) | grep fingerprint | sed 's/.*=//g' | sed 's/ //g'
      deb: deb http://repo.mongodb.org/apt/ubuntu {{ os_release['all'].ubuntu }}/mongodb-org/4.4 multiverse
      key: 20691EEC35216C63CAF66CE1656408E390CFB1F5
  ###
  ### PostgrSQL (currently obsolete)
  ###
  pgsql:
    # [Jessie]
    5.2:
      deb: deb https://apt-archive.postgresql.org/pub/repos/apt/ {{ os_release[5.2].debian }}-pgdg main
    # [Jessie]
    5.3:
      deb: deb https://apt-archive.postgresql.org/pub/repos/apt/ {{ os_release[5.3].debian }}-pgdg main
    # [Jessie]
    5.4:
      deb: deb https://apt-archive.postgresql.org/pub/repos/apt/ {{ os_release[5.4].debian }}-pgdg main
    # [Jessie]
    5.5:
      deb: deb https://apt-archive.postgresql.org/pub/repos/apt/ {{ os_release[5.5].debian }}-pgdg main
    # [Stretch]
    5.6:
      deb: deb http://apt.postgresql.org/pub/repos/apt/ {{ os_release[5.6].debian }}-pgdg main
      pre: curl -sS -k -L --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc | APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1 apt-key add -
    # [Stretch]
    7.0:
      deb: deb http://apt.postgresql.org/pub/repos/apt/ {{ os_release[7.0].debian }}-pgdg main
      pre: curl -sS -k -L --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc | APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1 apt-key add -
    # [Buster]
    7.1:
      deb: deb http://apt.postgresql.org/pub/repos/apt/ {{ os_release[7.1].debian }}-pgdg main
      pre: curl -sS -k -L --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc | APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1 apt-key add -
    # [Buster]
    7.2:
      deb: deb http://apt.postgresql.org/pub/repos/apt/ {{ os_release[7.2].debian }}-pgdg main
      pre: curl -sS -k -L --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc | APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1 apt-key add -
    # [Bullseye]
    all:
      deb: deb http://apt.postgresql.org/pub/repos/apt/ {{ os_release['all'].debian }}-pgdg main
      pre: curl -sS -k -L --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc | APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1 apt-key add -


# -------------------------------------------------------------------------------------------------
# Composer (PHP) definition
# -------------------------------------------------------------------------------------------------

# name:     Name of the PHP Composer package
# link:     [optional] Name of the binary to symlink to /usr/local/bin
# all:      is generic version of defines
# 7.2:      is specific version of defines
# disabled: [optional] Array of PHP versions for which to disable this module
# check:    [optional] Include a check command to test if it was installed successfully
# version:  Composer version: Either '1' or '2' for composer version
#
# all, 7.2, 7.1, 7.0, 5.6, 5.5, 5.4:
# version:  [optional] Specific version of Ruby gem
#
composer_available:
  asgardcms:
    disabled: [5.2, 5.3, 5.4, 8.0, 8.1, 8.2]
    check: asgardcms --version 2>/dev/null | grep -Ei 'AsgardCMS\sInstaller\s[0-9][.0-9]+'
    name: asgardcms/asgardcms-installer
    link: asgardcms
    version: 2
  codeception:
    disabled: [5.2, 5.3, 8.0, 8.1, 8.2]
    check: codecept --version 2>/dev/null | grep -E '^Codeception(\sversion)?\s[0-9][.0-9]+$'
    name: codeception/codeception
    link: codecept
    version: 2
  lumen:
    disabled: [5.2, 5.3, 5.4, 8.0, 8.1, 8.2]
    check: lumen --version 2>/dev/null | grep -E '^Lumen Installer\s[0-9][.0-9]+$'
    name: laravel/lumen-installer
    link: lumen
    version: 2
  #photon:
  #  disabled: [5.2, 5.3, 5.4, 8.0, 8.1, 8.2]
  #  check: photon --version | grep -E 'Installer [0-9][.0-9]+'
  #  name: photoncms/installer
  #  link: photon
  #  version: 2
  prestissimo:
    disabled: [5.2, 8.0, 8.1, 8.2]
    name: hirak/prestissimo
    version: 1


# -------------------------------------------------------------------------------------------------
# Gems (Ruby) definition
# -------------------------------------------------------------------------------------------------

# name:     Name of the Ruby gem package
# all:      is generic version of defines
# 7.2:      is specific version of defines
# disabled: [optional] Array of PHP versions for which to disable this module
# check:    [optional] Include a check command to test if it was installed successfully
#
# all, 7.2, 7.1, 7.0, 5.6, 5.5, 5.4:
# version:  [optional] Specific version of Ruby gem
#
gem_available:
  mixlib_config:
    name: mixlib-config
    all:
      version: 2.2.4
  # Required by rb-inotify, as otherwise rb-inotify will pull ffi as a dependency in a
  # version which is not supported by the ruby version (>= 2.3)
  ffi:
    name: ffi
    disabled: [5.6, 7.0, 7.1, 7.2, 7.3, 7.4, 8.0, 8.1, 8.2]
    all:
      version: 1.12.2
  rb_inotify:
    name: rb-inotify
    all:
      version: 0.9.10
  mdl:
    name: mdl
    check: mdl --version | grep -E '[0-9][.0-9]+'
    8.2:
      version: 0.5.0
    8.1:
      version: 0.5.0
    8.0:
      version: 0.5.0
    7.4:
      version: 0.5.0
    7.3:
      version: 0.5.0
    7.2:
      version: 0.5.0
    7.1:
      version: 0.5.0
    7.0:
      version: 0.5.0
    5.6:
      version: 0.5.0
    5.5:
      version: 0.5.0
    5.4:
      version: 0.5.0
    5.3:
      version: 0.5.0
    5.2:
      version: 0.5.0


# -------------------------------------------------------------------------------------------------
# npm (Node) definition
# -------------------------------------------------------------------------------------------------

# name:     Name of the Node npm package
# all:      is generic version of defines
# 7.2:      is specific version of defines
# disabled: [optional] Array of PHP versions for which to disable this module
# check:    [optional] Include a check command to test if it was installed successfully
#
# all, 7.2, 7.1, 7.0, 5.6, 5.5, 5.4:
# version:  [optional] Specific version of Node npm package
#
npm_available:
  angular_cli:
    name: "@angular/cli"
    check: ng  version 2>&1 | grep -iE 'Angular CLI:\s*[0-9][.0-9]+'
  eslint:
    name: eslint
    check: eslint -v | grep -E '[0-9][.0-9]+'
  grunt:
    name: grunt
  grunt_cli:
    name: grunt-cli
    check: grunt --version | grep -E '[0-9][.0-9]+'
  gulp:
    name: gulp
    check: gulp --version | grep -E '[0-9][.0-9]+'
  jsonlint:
    name: jsonlint
    check: jsonlint --version | grep -E '[0-9][.0-9]+'
  pm2:
    name: pm2
    check: pm2 --no-daemon --version | tail -1 | grep -E '[0-9][.0-9]+'
  mdlint:
    name: mdlint
    check: mdlint --version | grep -E '[0-9][.0-9]+'
  sass:
    name: sass
    check: sass --version | grep -E '[0-9][.0-9]+'
  stylelint:
    name: stylelint
    check: stylelint --version | grep -E '[0-9][.0-9]+'
  vue_cli:
    name: "@vue/cli"
    check: vue --version | grep -E '[0-9][.0-9]+'
  vue_cli_service_global:
    name: "@vue/cli-service-global"
  webpack:
    name: webpack
  webpack_cli:
    name: webpack-cli
    check: webpack --version | grep -E '[0-9][.0-9]+'


# -------------------------------------------------------------------------------------------------
# pip (Python) definition
# -------------------------------------------------------------------------------------------------

# name:     Name of the Python pip package
# all:      is generic version of defines
# 7.2:      is specific version of defines
# disabled: [optional] Array of PHP versions for which to disable this module
# check:    [optional] Include a check command to test if it was installed successfully
#
# all, 7.2, 7.1, 7.0, 5.6, 5.5, 5.4:
# version:  [optional] Specific version of Python pip package
#
pip_available:
  ansible:
    name: ansible
    all:
      version: 3.4.0
    check: ansible --version | grep -E '^ansible [0-9][.0-9]+$'
  yamllint:
    name: yamllint
    check: yamllint --version 2>&1 | grep -E '[0-9][.0-9]+'
  yq:
    name: yq
    check: yq --version 2>&1 | grep -E '^yq\s+[0-9][.0-9]+$'


# -------------------------------------------------------------------------------------------------
# Software definition
# -------------------------------------------------------------------------------------------------

# all: is generic version of defines
# 7.2: is specific version of defines
# disabled: [optional] Array of PHP versions for which to disable this module
# check:    [optional] Include a check command to test if it was installed successfully
#
# all, 7.2, 7.1, 7.0, 5.6, 5.5, 5.4:
#   pre:       [optional] Run command before 'command:' statement
#   command:   Command to execute
#   post:      [optional] Run command after 'command:' statement
#
software_available:
  # Composer is a dependency for others
  composer:
    disabled: [5.2]
    check: composer --version 2>/dev/null | grep -Ei '(composer|version)\s*[0-9][.0-9]+'
    5.3:
      pre: |
        COMPOSER_1_VERSION="latest-1.x" \
        && COMPOSER_2_VERSION="latest-2.2.x" \
      post: |
        ln -sf /usr/local/bin/composer-1 /usr/local/bin/composer \
    5.4:
      pre: |
        COMPOSER_1_VERSION="latest-1.x" \
        && COMPOSER_2_VERSION="latest-2.2.x" \
    5.5:
      pre: |
        COMPOSER_1_VERSION="latest-1.x" \
        && COMPOSER_2_VERSION="latest-2.2.x" \
    5.6:
      pre: |
        COMPOSER_1_VERSION="latest-1.x" \
        && COMPOSER_2_VERSION="latest-2.2.x" \
    7.0:
      pre: |
        COMPOSER_1_VERSION="latest-1.x" \
        && COMPOSER_2_VERSION="latest-2.2.x" \
    7.1:
      pre: |
        COMPOSER_1_VERSION="latest-1.x" \
        && COMPOSER_2_VERSION="latest-2.2.x" \
    all:
      pre: |
        COMPOSER_1_VERSION="latest-1.x" \
        && COMPOSER_2_VERSION="latest-2.x" \
      command: |
        curl -sS -L --fail "https://getcomposer.org/download/${COMPOSER_1_VERSION}/composer.phar" > /usr/local/bin/composer-1 \
        && curl -sS -L --fail "https://getcomposer.org/download/${COMPOSER_2_VERSION}/composer.phar" > /usr/local/bin/composer-2 \
        && chmod +x /usr/local/bin/composer-1 \
        && chmod +x /usr/local/bin/composer-2 \
      post: |
        ln -sf /usr/local/bin/composer-2 /usr/local/bin/composer \
  # pip is a dependency for others
  pip:
    5.2:
      command: |
        DEBIAN_FRONTEND=noninteractive apt-get update -qq \
        && DEBIAN_FRONTEND=noninteractive apt-get install -qq -y --no-install-recommends --no-install-suggests \
          libpython-dev \
        && DEBIAN_FRONTEND=noninteractive apt-get purge -qq -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \
        && rm -rf /var/lib/apt/lists/* \
        \
        && curl -sS -L --fail https://bootstrap.pypa.io/pip/2.7/get-pip.py | python \
    5.3:
      command: |
        DEBIAN_FRONTEND=noninteractive apt-get update -qq \
        && DEBIAN_FRONTEND=noninteractive apt-get install -qq -y --no-install-recommends --no-install-suggests \
          libpython-dev \
        && DEBIAN_FRONTEND=noninteractive apt-get purge -qq -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \
        && rm -rf /var/lib/apt/lists/* \
        \
        && curl -sS -L --fail https://bootstrap.pypa.io/pip/2.7/get-pip.py | python \
    5.4:
      command: |
        DEBIAN_FRONTEND=noninteractive apt-get update -qq \
        && DEBIAN_FRONTEND=noninteractive apt-get install -qq -y --no-install-recommends --no-install-suggests \
          libpython-dev \
        && DEBIAN_FRONTEND=noninteractive apt-get purge -qq -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \
        && rm -rf /var/lib/apt/lists/* \
        \
        && curl -sS -L --fail https://bootstrap.pypa.io/pip/2.7/get-pip.py | python \
    5.5:
      command: |
        DEBIAN_FRONTEND=noninteractive apt-get update -qq \
        && DEBIAN_FRONTEND=noninteractive apt-get install -qq -y --no-install-recommends --no-install-suggests \
          libpython-dev \
        && DEBIAN_FRONTEND=noninteractive apt-get purge -qq -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \
        && rm -rf /var/lib/apt/lists/* \
        \
        && curl -sS -L --fail https://bootstrap.pypa.io/pip/2.7/get-pip.py | python \
    5.6:
      command: |
        DEBIAN_FRONTEND=noninteractive apt-get update -qq \
        && DEBIAN_FRONTEND=noninteractive apt-get install -qq -y --no-install-recommends --no-install-suggests \
          libpython-dev \
        && DEBIAN_FRONTEND=noninteractive apt-get purge -qq -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \
        && rm -rf /var/lib/apt/lists/* \
        \
        && curl -sS -L --fail https://bootstrap.pypa.io/pip/2.7/get-pip.py | python \
    7.0:
      command: |
        DEBIAN_FRONTEND=noninteractive apt-get update -qq \
        && DEBIAN_FRONTEND=noninteractive apt-get install -qq -y --no-install-recommends --no-install-suggests \
          libpython-dev \
        && DEBIAN_FRONTEND=noninteractive apt-get purge -qq -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \
        && rm -rf /var/lib/apt/lists/* \
        \
        && curl -sS -L --fail https://bootstrap.pypa.io/pip/2.7/get-pip.py | python \
    7.1:
      command: |
        DEBIAN_FRONTEND=noninteractive apt-get update -qq \
        && DEBIAN_FRONTEND=noninteractive apt-get install -qq -y --no-install-recommends --no-install-suggests \
          libpython-dev \
        && DEBIAN_FRONTEND=noninteractive apt-get purge -qq -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \
        && rm -rf /var/lib/apt/lists/* \
        \
        && curl -sS -L --fail https://bootstrap.pypa.io/pip/2.7/get-pip.py | python \
    7.2:
      command: |
        DEBIAN_FRONTEND=noninteractive apt-get update -qq \
        && DEBIAN_FRONTEND=noninteractive apt-get install -qq -y --no-install-recommends --no-install-suggests \
          libpython-dev \
        && DEBIAN_FRONTEND=noninteractive apt-get purge -qq -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \
        && rm -rf /var/lib/apt/lists/* \
        \
        && curl -sS -L --fail https://bootstrap.pypa.io/pip/2.7/get-pip.py | python \
    all:
      command: |
        DEBIAN_FRONTEND=noninteractive apt-get update -qq \
        && DEBIAN_FRONTEND=noninteractive apt-get install -qq -y --no-install-recommends --no-install-suggests \
          libpython3-dev \
          python3-distutils \
        && DEBIAN_FRONTEND=noninteractive apt-get purge -qq -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \
        && rm -rf /var/lib/apt/lists/* \
        \
        && curl -sS -L --fail https://bootstrap.pypa.io/get-pip.py | python3 \
  # nvm is a dependency for others
  nvm:
    check: |
      su  -c '. {{ nvm_home }}/nvm.sh; nvm --version' devilbox | grep -E '^v?[0-9][.0-9]+' \
      && su  -c '. {{ nvm_home }}/nvm.sh; yarn --version' devilbox | grep -E '^v?[0-9][.0-9]+' \
    all:
      pre: |
        NVM_VERSION="$( \
          curl -sS 'https://github.com/nvm-sh/nvm/releases' \
          | grep -Eo '/nvm-sh/nvm/releases/tag/v?[.0-9]+"' \
          | grep -Eo 'v?[.0-9]+' \
          | sort -V \
          | tail -1 \
        )" \
        && mkdir -p {{ nvm_home }} \
      command: |
        curl -o- "https://raw.githubusercontent.com/nvm-sh/nvm/${NVM_VERSION}/install.sh" \
          | NVM_DIR="{{ nvm_home }}" bash \
        \
        && { \
          echo 'export NVM_DIR="{{ nvm_home }}"'; \
          echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm'; \
          echo '[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion'; \
        } >> /home/devilbox/.bashrc \
        \
        && chown -R devilbox:devilbox "{{ nvm_home }}" \
      # Install latest and LTS version and yarn
      post: |
        su  -c '. {{ nvm_home }}/nvm.sh; nvm install {{ node_version }}' devilbox \
        && su  -c '. {{ nvm_home }}/nvm.sh; nvm use {{ node_version }}' devilbox \
        && su  -c '. {{ nvm_home }}/nvm.sh; corepack enable' devilbox \
        \
        && chmod 0777 {{ nvm_home }} \
        && find {{ nvm_home }} -type f -print0 | xargs -n1 -0 chmod go+w \
        && find {{ nvm_home }} -type d -print0 | xargs -n1 -0 chmod 0777 \
  ###
  ### PostgrSQL Command line client
  ###
  # 5.2: (amd64)
  # 5.3: (amd64)
  # 5.4: (amd64)
  # 5.5: (amd64)
  # 5.6: (amd64)
  # 7.0: (amd64)
  # 7.1: (amd64, arm64)
  # 7.2: (amd64, arm64)
  # 7.3: (amd64, arm64)
  # 7.4: (amd64, arm64)
  # 8.0: (amd64, arm64)
  # 8.1: (amd64, arm64)
  # 8.2: (amd64, arm64)
  pgsql_client:
    check: |
      if echo '{{ php_version }}' | grep -E '^(5.2|5.3|5.4|5.5|5.6|7.0)$' >/dev/null; then \
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
        pg_isready --version; \
        fi \
      else \
        pg_isready --version; \
      fi \
    5.2:
      pre: |
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
          curl -sS -k -L --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc | APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1 apt-key add - \
          && echo "deb https://apt-archive.postgresql.org/pub/repos/apt/ {{ os_release[php_version].debian }}-pgdg main" > /etc/apt/sources.list.d/pgsql.list \
          && apt-get update; \
        fi \
      command: |
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
          apt-get install -y --no-install-recommends --no-install-suggests \
            postgresql-client; \
        fi \
    5.3:
      pre: |
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
          curl -sS -k -L --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc | APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1 apt-key add - \
          && echo "deb https://apt-archive.postgresql.org/pub/repos/apt/ {{ os_release[php_version].debian }}-pgdg main" > /etc/apt/sources.list.d/pgsql.list \
          && apt-get update; \
        fi \
      command: |
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
          apt-get install -y --no-install-recommends --no-install-suggests \
            postgresql-client; \
        fi \
    5.4:
      pre: |
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
          curl -sS -k -L --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc | APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1 apt-key add - \
          && echo "deb https://apt-archive.postgresql.org/pub/repos/apt/ {{ os_release[php_version].debian }}-pgdg main" > /etc/apt/sources.list.d/pgsql.list \
          && apt-get update; \
        fi \
      command: |
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
          apt-get install -y --no-install-recommends --no-install-suggests \
            postgresql-client; \
        fi \
    5.5:
      pre: |
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
          curl -sS -k -L --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc | APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1 apt-key add - \
          && echo "deb https://apt-archive.postgresql.org/pub/repos/apt/ {{ os_release[php_version].debian }}-pgdg main" > /etc/apt/sources.list.d/pgsql.list \
          && apt-get update; \
        fi \
      command: |
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
          apt-get install -y --no-install-recommends --no-install-suggests \
            postgresql-client; \
        fi \
    5.6:
      pre: |
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
          curl -sS -k -L --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc | APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1 apt-key add - \
          && echo "deb http://apt.postgresql.org/pub/repos/apt/ {{ os_release[php_version].debian }}-pgdg main" > /etc/apt/sources.list.d/pgsql.list \
          && apt-get update; \
        fi \
      command: |
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
          apt-get install -y --no-install-recommends --no-install-suggests \
            postgresql-client; \
        fi \
    7.0:
      pre: |
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
          curl -sS -k -L --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc | APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1 apt-key add - \
          && echo "deb http://apt.postgresql.org/pub/repos/apt/ {{ os_release[php_version].debian }}-pgdg main" > /etc/apt/sources.list.d/pgsql.list \
          && apt-get update; \
        fi \
      command: |
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
          apt-get install -y --no-install-recommends --no-install-suggests \
            postgresql-client; \
        fi \
    all:
      pre: |
        curl -sS -k -L --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc | APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1 apt-key add - \
        && echo "deb http://apt.postgresql.org/pub/repos/apt/ {{ os_release[php_version].debian }}-pgdg main" > /etc/apt/sources.list.d/pgsql.list \
        && apt-get update \
      command: |
        apt-get install -y --no-install-recommends --no-install-suggests \
          postgresql-client \
      post: rm -rf /var/lib/apt/lists/*
  ###
  ### MongoDB Command line client
  ###
  # 5.2: mongodb-clients (amd64)
  # 5.3: mongodb-clients (amd64)
  # 5.4: mongodb-clients (amd64)
  # 5.5: mongodb-clients (amd64)
  # 5.6: mongodb-clients & mongo-tools (amd64, arm64)
  # 7.0: mongodb-clients & mongo-tools (amd64, arm64)
  # 7.1: mongodb-org-(tools|shell) (amd64, arm64)
  # 7.2: mongodb-org-(tools|shell) (amd64, arm64)
  # 7.3: mongodb-org-(tools|shell) (amd64, arm64)
  # 7.4: mongodb-org-(tools|shell) (amd64, arm64)
  # 8.0: mongodb-org-(tools|shell) (amd64, arm64)
  # 8.1: mongodb-org-(tools|shell) (amd64, arm64)
  # 8.2: mongodb-org-(tools|shell) (amd64, arm64)
  mongo_client:
    check: |
      if echo '{{ php_version }}' | grep -E '^(5.2|5.3|5.4|5.5|5.6|7.0)$' >/dev/null; then \
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
          mongofiles --version; \
        fi \
      else \
        mongofiles --version; \
      fi \
    5.2:
      pre: apt-get update
      command: |
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
          apt-get install -y --no-install-recommends --no-install-suggests \
            mongodb-clients; \
        fi \
    5.3:
      pre: apt-get update
      command: |
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
          apt-get install -y --no-install-recommends --no-install-suggests \
            mongodb-clients; \
        fi \
    5.4:
      pre: apt-get update
      command: |
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
          apt-get install -y --no-install-recommends --no-install-suggests \
            mongodb-clients; \
        fi \
    5.5:
      pre: apt-get update
      command: |
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
          apt-get install -y --no-install-recommends --no-install-suggests \
            mongodb-clients; \
        fi \
    5.6:
      pre: apt-get update
      command: |
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
          apt-get install -y --no-install-recommends --no-install-suggests \
            mongodb-clients \
            mongo-tools; \
        else \
          apt-get install -y --no-install-recommends --no-install-suggests \
            mongodb-clients; \
        fi \
    7.0:
      pre: apt-get update
      command: |
        if [ "$(dpkg-architecture --query DEB_BUILD_ARCH)" = "amd64" ]; then \
          apt-get install -y --no-install-recommends --no-install-suggests \
            mongodb-clients \
            mongo-tools; \
        else \
          apt-get install -y --no-install-recommends --no-install-suggests \
            mongodb-clients; \
        fi \
    all:
      pre: |
        APT_KEY_DONT_WARN_ON_DANGEROUS_USAGE=1 apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 20691EEC35216C63CAF66CE1656408E390CFB1F5 \
        && echo "deb http://repo.mongodb.org/apt/ubuntu {{ os_release[php_version].ubuntu }}/mongodb-org/4.4 multiverse" > /etc/apt/sources.list.d/mongo.list \
        && apt-get update \
      command: |
        apt-get install -y --no-install-recommends --no-install-suggests \
          mongodb-org-tools \
          mongodb-org-shell \
      post: rm -rf /var/lib/apt/lists/*
  awesomeci:
    check: regex-grep --version | grep -E '[0-9][.0-9]+'
    all:
      command: |
        git clone https://github.com/cytopia/awesome-ci.git /usr/local/src/awesome-ci \
        && cd /usr/local/src/awesome-ci \
        && git checkout $(git describe --abbrev=0 --tags) \
        && ./configure --prefix=/usr/local \
        && make install \
        && cd / \
        && rm -rf /usr/local/src/awesome-ci \
  deployer:
    disabled: [5.2, 5.3]
    check: dep --version 2>/dev/null | grep -Ei 'deployer\s*(version\s*)?[0-9][.0-9]+'
    5.4:
      command: curl -sS -k -L --fail https://deployer.org/releases/v3.3.0/deployer.phar -L -o /usr/local/bin/dep
      post: chmod +x /usr/local/bin/dep
    5.5:
      command: curl -sS -k -L --fail https://deployer.org/releases/v4.3.4/deployer.phar -L -o /usr/local/bin/dep
      post: chmod +x /usr/local/bin/dep
    5.6:
      command: curl -sS -k -L --fail https://deployer.org/releases/v4.3.4/deployer.phar -L -o /usr/local/bin/dep
      post: chmod +x /usr/local/bin/dep
    7.0:
      command: curl -sS -k -L --fail https://deployer.org/releases/v6.7.0/deployer.phar -L -o /usr/local/bin/dep
      post: chmod +x /usr/local/bin/dep
    7.1:
      command: curl -sS -k -L --fail https://deployer.org/releases/v6.7.0/deployer.phar -L -o /usr/local/bin/dep
      post: chmod +x /usr/local/bin/dep
    all:
      command: curl -sS -k -L --fail https://deployer.org/deployer.phar -L -o /usr/local/bin/dep
      post: chmod +x /usr/local/bin/dep
  drush7:
    disabled: [5.2, 8.0, 8.1, 8.2]
    check: drush7 --version | grep -E '7[.0-9]+\s*$'
    all:
      pre: |
        git clone https://github.com/drush-ops/drush.git /usr/local/src/drush7 \
        && cd /usr/local/src/drush7 \
        && git checkout 7.4.0 \
      command: |
        chown -R ${MY_USER}:${MY_GROUP} /usr/local/src/drush7 \
        && su - ${MY_USER} -c 'PATH=/usr/local/bin:$PATH; cd /usr/local/src/drush7 && COMPOSER_MEMORY_LIMIT=-1 /usr/local/bin/composer-1 install --no-interaction --no-progress --no-dev' \
        && ln -s /usr/local/src/drush7/drush /usr/local/bin/drush7 \
        && rm -rf /usr/local/src/drush7/.git \
        && rm -rf /usr/local/src/drush7/docs \
        && rm -rf /usr/local/src/drush7/examples \
        && rm -rf /usr/local/src/drush7/misc \
  drush8:
    disabled: [5.2, 5.3, 8.0, 8.1, 8.2]
    check: drush8 --version | grep -E '8[.0-9]+\s*$'
    all:
      pre: |
        git clone https://github.com/drush-ops/drush.git /usr/local/src/drush8 \
        && cd /usr/local/src/drush8 \
        && git checkout $( git for-each-ref --format='%(*creatordate:raw)%(creatordate:raw) %(refname)' refs/tags | sort -n | grep -E 'tags/8[.0-9]+$' | tail -1 | sed 's|.*/||g' ) \
      command: |
        chown -R ${MY_USER}:${MY_GROUP} /usr/local/src/drush8 \
        && su - ${MY_USER} -c 'PATH=/usr/local/bin:$PATH; cd /usr/local/src/drush8 && COMPOSER_MEMORY_LIMIT=-1 /usr/local/bin/composer-1 install --no-interaction --no-progress --no-dev' \
        && ln -s /usr/local/src/drush8/drush /usr/local/bin/drush8 \
        && rm -rf /usr/local/src/drush8/.git \
        && rm -rf /usr/local/src/drush8/docs \
        && rm -rf /usr/local/src/drush8/examples \
        && rm -rf /usr/local/src/drush8/misc \
  drush9:
    disabled: [5.2, 5.3, 5.4, 5.5, 7.0, 7.1, 8.0, 8.1, 8.2]
    check: drush9 --version | grep -E '9[.0-9]+\s*$'
    all:
      pre: |
        git clone https://github.com/drush-ops/drush.git /usr/local/src/drush9 \
        && cd /usr/local/src/drush9 \
        && git checkout $( git for-each-ref --format='%(*creatordate:raw)%(creatordate:raw) %(refname)' refs/tags | sort -n | grep -E 'tags/9[.0-9]+$' | tail -1 | sed 's|.*/||g' ) \
      command: |
        chown -R ${MY_USER}:${MY_GROUP} /usr/local/src/drush9 \
        && su - ${MY_USER} -c 'PATH=/usr/local/bin:$PATH; cd /usr/local/src/drush9 && COMPOSER_MEMORY_LIMIT=-1 /usr/local/bin/composer-1 install --no-interaction --no-progress' \
        && ln -s /usr/local/src/drush9/drush /usr/local/bin/drush9 \
        && rm -rf /usr/local/src/drush9/.git \
        && rm -rf /usr/local/src/drush9/docs \
        && rm -rf /usr/local/src/drush9/examples \
        && rm -rf /usr/local/src/drush9/misc \
  drupalconsole:
    disabled: [5.2, 5.3, 5.4, 7.0, 7.1, 8.0, 8.1, 8.2] # TODO: re-enable for 8.0 (currently errors)
    check: drupal --version | grep -E 'Drupal Console Launcher\s*[0-9][.0-9]'
    5.5:
      pre: DURL="https://github.com/hechoendrupal/drupal-console-launcher/releases/download/1.9.4/drupal.phar"
    5.6:
      pre: DURL="https://github.com/hechoendrupal/drupal-console-launcher/releases/download/1.9.4/drupal.phar"
    7.0:
      pre: DURL="https://github.com/hechoendrupal/drupal-console-launcher/releases/download/1.9.4/drupal.phar"
    7.1:
      pre: DURL="https://github.com/hechoendrupal/drupal-console-launcher/releases/download/1.9.4/drupal.phar"
    all:
      pre: DURL="https://github.com$(curl -sS 'https://github.com/hechoendrupal/drupal-console-launcher/releases' | grep -Eo 'href="/.+drupal.phar"' | head -1 | sed 's/^href="//g' | sed 's/"$//g')"
      command: curl -sS -L --fail "${DURL}" -L -o /usr/local/bin/drupal
      post: chmod +x /usr/local/bin/drupal
  gitflow:
    check: git-flow version | grep -E '[0-9][.0-9]+'
    all:
      command: |
        git clone https://github.com/petervanderdoes/gitflow-avh /tmp/gitflow \
        && cd /tmp/gitflow \
        && make install \
        && cd / && rm -rf /tmp/gitflow \
  homebrew:
    all:
      command: |
        git clone https://github.com/Homebrew/brew.git /usr/local/src/brew \
        && chown -R ${MY_USER}:${MY_GROUP} /usr/local/src/brew \
        && v="${BASH_PROFILE}" su ${MY_USER} -c -p \
        'echo "PATH=/usr/local/src/brew/bin:/usr/local/src/brew/sbin:/usr/bin:/usr/sbin:/bin:/sbin" >> /home/devilbox/${v}' \
        && v="${BASH_PROFILE}" su ${MY_USER} -c -p \
        'echo "export MANPATH=/usr/local/src/brew/manpages:${MANPATH}"   >> /home/devilbox/${v}' \
        && v="${BASH_PROFILE}" su ${MY_USER} -c -p \
        'echo "export INFOPATH=/usr/local/src/brew/manpages:${INFOPATH}" >> /home/devilbox/${v}' \
        && su - ${MY_USER} -c '/usr/local/src/brew/bin/brew config' \
  laravel:
    check: laravel --version | grep -E '(Installer|version)\s*[0-9][.0-9]+'
    disabled: [5.2, 5.3, 8.2]
    5.4:
      pre: |
        git clone https://github.com/laravel/installer /usr/local/src/laravel-installer \
        && cd /usr/local/src/laravel-installer \
        && git checkout v1.3.7 \
      post:
        ln -s /usr/local/src/laravel-installer/laravel /usr/local/bin/laravel
    5.5:
      pre: |
        git clone https://github.com/laravel/installer /usr/local/src/laravel-installer \
        && cd /usr/local/src/laravel-installer \
        && git checkout v2.0.0 \
      post:
        ln -s /usr/local/src/laravel-installer/laravel /usr/local/bin/laravel
    5.6:
      pre: |
        git clone https://github.com/laravel/installer /usr/local/src/laravel-installer \
        && cd /usr/local/src/laravel-installer \
        && git checkout v2.0.0 \
      post:
        ln -s /usr/local/src/laravel-installer/laravel /usr/local/bin/laravel
    7.0:
      pre: |
        git clone https://github.com/laravel/installer /usr/local/src/laravel-installer \
        && cd /usr/local/src/laravel-installer \
        && git checkout v2.0.0 \
      post:
        ln -s /usr/local/src/laravel-installer/laravel /usr/local/bin/laravel
    7.1:
      pre: |
        git clone https://github.com/laravel/installer /usr/local/src/laravel-installer \
        && cd /usr/local/src/laravel-installer \
        && git checkout $(git tag | grep '^v2\.3\.' | sort -u | tail -1) \
      post:
        ln -s /usr/local/src/laravel-installer/laravel /usr/local/bin/laravel
    7.2:
      pre: |
        git clone https://github.com/laravel/installer /usr/local/src/laravel-installer \
        && cd /usr/local/src/laravel-installer \
        && git checkout v4.0.0 \
      post:
        ln -s /usr/local/src/laravel-installer/bin/laravel /usr/local/bin/laravel
    all:
      pre: |
        git clone https://github.com/laravel/installer /usr/local/src/laravel-installer \
        && cd /usr/local/src/laravel-installer \
        && git checkout $(git describe --abbrev=0 --tags) \
      command: |
        chown -R ${MY_USER}:${MY_GROUP} /usr/local/src/laravel-installer \
        && su - ${MY_USER} -c 'PATH=/usr/local/bin:$PATH; cd /usr/local/src/laravel-installer && COMPOSER_MEMORY_LIMIT=-1 /usr/local/bin/composer install --no-interaction --no-progress --no-dev' \
        && rm -rf /usr/local/src/laravel-installer/laravel/.git \
      post:
        ln -s /usr/local/src/laravel-installer/bin/laravel /usr/local/bin/laravel
  linkcheck:
    check: linkcheck --version | grep -E '^linkcheck\sv[0-9][.0-9]+'
    all:
      command: |
        curl -sS -L --fail https://raw.githubusercontent.com/cytopia/linkcheck/master/linkcheck > /usr/local/bin/linkcheck \
        && chmod +x /usr/local/bin/linkcheck \
  mhsendmail:
    all:
      command: |
        if [ "$(dpkg-architecture --query DEB_HOST_ARCH)" = "amd64" ]; then \
          curl -sS -L --fail https://github.com/devilbox/mhsendmail/releases/download/v0.3.0/mhsendmail_linux_amd64 > mhsendmail_linux_amd64 \
          && chmod +x mhsendmail_linux_amd64 \
          && mv mhsendmail_linux_amd64 /usr/local/bin/mhsendmail; \
        fi \
  mysqldumpsecure:
    check: mysqldump-secure --version | grep -E 'Version:\s*[0-9][.0-9]+'
    all:
      command: |
        git clone https://github.com/cytopia/mysqldump-secure.git /usr/local/src/mysqldump-secure \
        && cd /usr/local/src/mysqldump-secure \
        && git checkout $(git describe --abbrev=0 --tags) \
        && cp /usr/local/src/mysqldump-secure/bin/mysqldump-secure /usr/local/bin \
        && cp /usr/local/src/mysqldump-secure/etc/mysqldump-secure.conf /etc \
        && cp /usr/local/src/mysqldump-secure/etc/mysqldump-secure.cnf /etc \
        && touch /var/log/mysqldump-secure.log \
        && chown ${MY_USER}:${MY_GROUP} /etc/mysqldump-secure.* \
        && chown ${MY_USER}:${MY_GROUP} /var/log/mysqldump-secure.log \
        && chmod 0400 /etc/mysqldump-secure.conf \
        && chmod 0400 /etc/mysqldump-secure.cnf \
        && chmod 0644 /var/log/mysqldump-secure.log \
        && sed -i'' 's/^COMPRESS_ARG=.*/COMPRESS_ARG="-9 -c"/g' /etc/mysqldump-secure.conf \
        && sed -i'' 's/^DUMP_DIR=.*/DUMP_DIR="\/shared\/backups\/mysql"/g' /etc/mysqldump-secure.conf \
        && sed -i'' 's/^DUMP_DIR_CHMOD=.*/DUMP_DIR_CHMOD="0755"/g' /etc/mysqldump-secure.conf \
        && sed -i'' 's/^DUMP_FILE_CHMOD=.*/DUMP_FILE_CHMOD="0644"/g' /etc/mysqldump-secure.conf \
        && sed -i'' 's/^LOG_CHMOD=.*/LOG_CHMOD="0644"/g' /etc/mysqldump-secure.conf \
        && sed -i'' 's/^NAGIOS_LOG=.*/NAGIOS_LOG=0/g' /etc/mysqldump-secure.conf \
        && cd / \
        && rm -rf /usr/local/src/mysqldump-secure \
  phalcon:
    disabled: [5.2, 7.4, 8.0, 8.1, 8.2] # TODO: currently disabled for 7.4 as it breaks (from mods.yml)
    check: phalcon commands | grep -E '[0-9][.0-9]+'
    5.3:
      pre: |
        git clone https://github.com/phalcon/phalcon-devtools /usr/local/src/phalcon-devtools \
        && cd /usr/local/src/phalcon-devtools \
        && git checkout v2.0.7 \
      command: |
        chown -R ${MY_USER}:${MY_GROUP} /usr/local/src/phalcon-devtools \
        && su - ${MY_USER} -c 'cd /usr/local/src/phalcon-devtools && ./phalcon.sh' \
        && ln -s /usr/local/src/phalcon-devtools/phalcon.php /usr/local/bin/phalcon \
        && cd / \
        && rm -rf /usr/local/src/phalcon-devtools/.git \
    5.4:
      pre: |
        git clone https://github.com/phalcon/phalcon-devtools /usr/local/src/phalcon-devtools \
        && cd /usr/local/src/phalcon-devtools \
        && git checkout v2.0.9 \
      command: |
        chown -R ${MY_USER}:${MY_GROUP} /usr/local/src/phalcon-devtools \
        && su - ${MY_USER} -c 'cd /usr/local/src/phalcon-devtools && ./phalcon.sh' \
        && ln -sf /usr/local/src/phalcon-devtools/phalcon.php /usr/local/bin/phalcon \
        && cd / \
        && rm -rf /usr/local/src/phalcon-devtools/.git \
    5.5:
      pre: |
        git clone https://github.com/phalcon/phalcon-devtools /usr/local/src/phalcon-devtools \
        && cd /usr/local/src/phalcon-devtools \
        && git checkout v3.4.11 \
      command: |
        chown -R ${MY_USER}:${MY_GROUP} /usr/local/src/phalcon-devtools \
        && su - ${MY_USER} -c 'cd /usr/local/src/phalcon-devtools && ./phalcon.sh' \
        && ln -sf /usr/local/src/phalcon-devtools/phalcon /usr/local/bin/phalcon \
        && chmod +x /usr/local/bin/phalcon \
        && cd / \
        && rm -rf /usr/local/src/phalcon-devtools/.git \
    5.6:
      pre: |
        git clone https://github.com/phalcon/phalcon-devtools /usr/local/src/phalcon-devtools \
        && cd /usr/local/src/phalcon-devtools \
        && git checkout v3.4.11 \
      command: |
        chown -R ${MY_USER}:${MY_GROUP} /usr/local/src/phalcon-devtools \
        && su - ${MY_USER} -c 'cd /usr/local/src/phalcon-devtools && ./phalcon.sh' \
        && ln -sf /usr/local/src/phalcon-devtools/phalcon /usr/local/bin/phalcon \
        && chmod +x /usr/local/bin/phalcon \
        && cd / \
        && rm -rf /usr/local/src/phalcon-devtools/.git \
    7.0:
      pre: |
        git clone https://github.com/phalcon/phalcon-devtools /usr/local/src/phalcon-devtools \
        && cd /usr/local/src/phalcon-devtools \
        && git checkout v3.4.11 \
      command: |
        chown -R ${MY_USER}:${MY_GROUP} /usr/local/src/phalcon-devtools \
        && su - ${MY_USER} -c 'cd /usr/local/src/phalcon-devtools && ./phalcon.sh' \
        && ln -sf /usr/local/src/phalcon-devtools/phalcon /usr/local/bin/phalcon \
        && chmod +x /usr/local/bin/phalcon \
        && cd / \
        && rm -rf /usr/local/src/phalcon-devtools/.git \
    7.1:
      pre: |
        git clone https://github.com/phalcon/phalcon-devtools /usr/local/src/phalcon-devtools \
        && cd /usr/local/src/phalcon-devtools \
        && git checkout v3.4.11 \
      command: |
        chown -R ${MY_USER}:${MY_GROUP} /usr/local/src/phalcon-devtools \
        && su - ${MY_USER} -c 'cd /usr/local/src/phalcon-devtools && ./phalcon.sh' \
        && ln -sf /usr/local/src/phalcon-devtools/phalcon /usr/local/bin/phalcon \
        && chmod +x /usr/local/bin/phalcon \
        && cd / \
        && rm -rf /usr/local/src/phalcon-devtools/.git \
    all:
      pre: |
        git clone https://github.com/phalcon/phalcon-devtools /usr/local/src/phalcon-devtools \
        && cd /usr/local/src/phalcon-devtools \
        && git checkout $(git describe --abbrev=0 --tags) \
        && COMPOSER_MEMORY_LIMIT=-1 /usr/local/bin/composer install \
      command: |
        chown -R ${MY_USER}:${MY_GROUP} /usr/local/src/phalcon-devtools \
        && su - ${MY_USER} -c 'cd /usr/local/src/phalcon-devtools && ./phalcon.sh' \
        && ln -sf /usr/local/src/phalcon-devtools/phalcon /usr/local/bin/phalcon \
        && chmod +x phalcon \
        && cd / \
        && rm -rf /usr/local/src/phalcon-devtools/.git \
  phpcs:
    check: phpcs --version | grep -E 'version [0-9][.0-9]+'
    5.2:
      command: |
        curl -sS -L --fail https://github.com/squizlabs/PHP_CodeSniffer/releases/download/2.9.0/phpcs.phar > /usr/local/bin/phpcs \
        && chmod +x /usr/local/bin/phpcs \
    5.3:
      command: |
        curl -sS -L --fail https://github.com/squizlabs/PHP_CodeSniffer/releases/download/2.9.0/phpcs.phar > /usr/local/bin/phpcs \
        && chmod +x /usr/local/bin/phpcs \
    all:
      command: |
        curl -sS -L --fail https://squizlabs.github.io/PHP_CodeSniffer/phpcs.phar > /usr/local/bin/phpcs \
        && chmod +x /usr/local/bin/phpcs \
  phpcbf:
    check: phpcbf --version | grep -E 'version [0-9][.0-9]+'
    5.2:
      command: |
        curl -sS -L --fail https://github.com/squizlabs/PHP_CodeSniffer/releases/download/2.9.0/phpcbf.phar > /usr/local/bin/phpcbf \
        && chmod +x /usr/local/bin/phpcbf \
    5.3:
      command: |
        curl -sS -L --fail https://github.com/squizlabs/PHP_CodeSniffer/releases/download/2.9.0/phpcbf.phar > /usr/local/bin/phpcbf \
        && chmod +x /usr/local/bin/phpcbf \
    all:
      command: |
        curl -sS -L --fail https://squizlabs.github.io/PHP_CodeSniffer/phpcbf.phar > /usr/local/bin/phpcbf \
        && chmod +x /usr/local/bin/phpcbf \
  php-cs-fixer:
    disabled: [5.2, 8.2]
    check: php-cs-fixer --version 2>&1 | grep -E 'Fixer\s+(version\s*)?[-_.0-9]+\s+'
    5.3:
      command: |
        curl -sS -k -L --fail https://github.com/FriendsOfPHP/PHP-CS-Fixer/releases/download/v2.2.19/php-cs-fixer.phar > /usr/local/bin/php-cs-fixer \
        && chmod +x /usr/local/bin/php-cs-fixer \
    5.4:
      command: |
        curl -sS -k -L --fail https://github.com/FriendsOfPHP/PHP-CS-Fixer/releases/download/v2.2.19/php-cs-fixer.phar > /usr/local/bin/php-cs-fixer \
        && chmod +x /usr/local/bin/php-cs-fixer \
    5.5:
      command: |
        curl -sS -k -L --fail https://github.com/FriendsOfPHP/PHP-CS-Fixer/releases/download/v2.2.19/php-cs-fixer.phar > /usr/local/bin/php-cs-fixer \
        && chmod +x /usr/local/bin/php-cs-fixer \
    5.6:
      command: |
        curl -sS -k -L --fail https://cs.symfony.com/download/php-cs-fixer-v2.phar > /usr/local/bin/php-cs-fixer \
        && chmod +x /usr/local/bin/php-cs-fixer \
    7.0:
      command: |
        curl -sS -k -L --fail https://cs.symfony.com/download/php-cs-fixer-v2.phar > /usr/local/bin/php-cs-fixer \
        && chmod +x /usr/local/bin/php-cs-fixer \
    7.1:
      command: |
        curl -sS -k -L --fail https://cs.symfony.com/download/php-cs-fixer-v2.phar > /usr/local/bin/php-cs-fixer \
        && chmod +x /usr/local/bin/php-cs-fixer \
    7.2:
      command: |
        curl -sS -k -L --fail https://cs.symfony.com/download/php-cs-fixer-v2.phar > /usr/local/bin/php-cs-fixer \
        && chmod +x /usr/local/bin/php-cs-fixer \
    7.3:
      command: |
        curl -sS -k -L --fail https://cs.symfony.com/download/php-cs-fixer-v2.phar > /usr/local/bin/php-cs-fixer \
        && chmod +x /usr/local/bin/php-cs-fixer \
    all:
      command: |
        curl -sS -k -L --fail https://cs.symfony.com/download/php-cs-fixer-v3.phar > /usr/local/bin/php-cs-fixer \
        && chmod +x /usr/local/bin/php-cs-fixer \
  phpmd:
    disabled: [5.2]
    check: phpmd --version | grep -E '^PHPMD [0-9][.0-9]+'
    all:
      command: |
        curl -sS -k -L --fail https://phpmd.org/static/latest/phpmd.phar > phpmd.phar \
        && mv phpmd.phar /usr/local/bin/phpmd \
        && chmod +x /usr/local/bin/phpmd \
  phpunit:
    disabled: [5.2, 8.0, 8.1, 8.2]
    check: phpunit --version | grep -iE '^PHPUnit\s[0-9][.0-9]+'
    5.3:
      command: |
        curl -sS -k -L --fail https://phar.phpunit.de/phpunit-4.phar > /usr/local/bin/phpunit \
        && chmod +x /usr/local/bin/phpunit \
    5.4:
      command: |
        curl -sS -k -L --fail https://phar.phpunit.de/phpunit-4.phar > /usr/local/bin/phpunit \
        && chmod +x /usr/local/bin/phpunit \
    5.5:
      command: |
        curl -sS -k -L --fail https://phar.phpunit.de/phpunit-4.phar > /usr/local/bin/phpunit \
        && chmod +x /usr/local/bin/phpunit \
    5.6:
      command: |
        curl -sS -k -L --fail https://phar.phpunit.de/phpunit-5.phar > /usr/local/bin/phpunit \
        && chmod +x /usr/local/bin/phpunit \
    7.0:
      command: |
        curl -sS -k -L --fail https://phar.phpunit.de/phpunit-6.phar > /usr/local/bin/phpunit \
        && chmod +x /usr/local/bin/phpunit \
    all:
      command: |
        curl -sS -k -L --fail https://phar.phpunit.de/phpunit-7.phar > /usr/local/bin/phpunit \
        && chmod +x /usr/local/bin/phpunit \
  symfony:
    disabled: [5.2, 5.3]
    check: symfony -V | grep -Ei 'version\s*.*v[0-9][.0-9]+'
    all:
      pre: SYMFONY_VERSION="$( curl -sS -L --fail https://get.symfony.com/cli/LATEST )"
      command: curl -sS -L --fail "https://github.com/symfony/cli/releases/download/v${SYMFONY_VERSION}/symfony_linux_$(dpkg-architecture --query DEB_HOST_ARCH)" > /usr/local/bin/symfony
      post: chmod +x /usr/local/bin/symfony
  wkhtmltopdf:
    check: if [ "$(dpkg-architecture --query DEB_HOST_ARCH)" = "amd64" ]; then wkhtmltopdf --version | grep -E "^wkhtmltopdf [0-9][.0-9]+\s+\(.+patched.+\)"; fi
    5.2:
      pre: VERSION="$( curl -sSL -L --fail https://github.com/wkhtmltopdf/wkhtmltopdf/releases | grep -Eo '/wkhtmltopdf/.+jessie_amd64\.deb' | head -1 )"
      command: |
        if [ "$(dpkg-architecture --query DEB_HOST_ARCH)" = "amd64" ]; then \
          DEBIAN_FRONTEND=noninteractive apt-get update -qq \
          && DEBIAN_FRONTEND=noninteractive apt-get install -qq -y --no-install-recommends --no-install-suggests \
            libfontenc1 libxfont1 xfonts-75dpi xfonts-base xfonts-encodings xfonts-utils \
          && curl -sS -L --fail -o /tmp/wkhtmltopdf.deb  https://github.com/${VERSION} \
          && dpkg -i /tmp/wkhtmltopdf.deb \
          && rm -f /tmp/wkhtmltopdf.deb; \
        fi \
    5.3:
      pre: VERSION="$( curl -sSL -L --fail https://github.com/wkhtmltopdf/wkhtmltopdf/releases | grep -Eo '/wkhtmltopdf/.+jessie_amd64\.deb' | head -1 )"
      command: |
        if [ "$(dpkg-architecture --query DEB_HOST_ARCH)" = "amd64" ]; then \
          DEBIAN_FRONTEND=noninteractive apt-get update -qq \
          && DEBIAN_FRONTEND=noninteractive apt-get install -qq -y --no-install-recommends --no-install-suggests \
            libfontenc1 libxfont1 xfonts-75dpi xfonts-base xfonts-encodings xfonts-utils \
          && curl -sS -L --fail -o /tmp/wkhtmltopdf.deb  https://github.com/${VERSION} \
          && dpkg -i /tmp/wkhtmltopdf.deb \
          && rm -f /tmp/wkhtmltopdf.deb; \
        fi \
    5.4:
      pre: VERSION="$( curl -sSL -L --fail https://github.com/wkhtmltopdf/wkhtmltopdf/releases | grep -Eo '/wkhtmltopdf/.+jessie_amd64\.deb' | head -1 )"
      command: |
        if [ "$(dpkg-architecture --query DEB_HOST_ARCH)" = "amd64" ]; then \
          DEBIAN_FRONTEND=noninteractive apt-get update -qq \
          && DEBIAN_FRONTEND=noninteractive apt-get install -qq -y --no-install-recommends --no-install-suggests \
            libfontenc1 libxfont1 xfonts-75dpi xfonts-base xfonts-encodings xfonts-utils \
          && curl -sS -L --fail -o /tmp/wkhtmltopdf.deb  https://github.com/${VERSION} \
          && dpkg -i /tmp/wkhtmltopdf.deb \
          && rm -f /tmp/wkhtmltopdf.deb; \
        fi \
    5.5:
      pre: VERSION="$( curl -sSL -L --fail https://github.com/wkhtmltopdf/wkhtmltopdf/releases | grep -Eo '/wkhtmltopdf/.+jessie_amd64\.deb' | head -1 )"
      command: |
        if [ "$(dpkg-architecture --query DEB_HOST_ARCH)" = "amd64" ]; then \
          DEBIAN_FRONTEND=noninteractive apt-get update -qq \
          && DEBIAN_FRONTEND=noninteractive apt-get install -qq -y --no-install-recommends --no-install-suggests \
            libfontenc1 libxfont1 xfonts-75dpi xfonts-base xfonts-encodings xfonts-utils \
          && curl -sS -L --fail -o /tmp/wkhtmltopdf.deb  https://github.com/${VERSION} \
          && dpkg -i /tmp/wkhtmltopdf.deb \
          && rm -f /tmp/wkhtmltopdf.deb; \
        fi \
    5.6:
      command: |
        if [ "$(dpkg-architecture --query DEB_HOST_ARCH)" = "amd64" ]; then \
          DEBIAN_FRONTEND=noninteractive apt-get update -qq \
          && DEBIAN_FRONTEND=noninteractive apt-get install -qq -y --no-install-recommends --no-install-suggests \
            libfontenc1 libxfont1 xfonts-75dpi xfonts-base xfonts-encodings xfonts-utils \
          && curl -sS -L --fail -o /tmp/wkhtmltopdf.deb  https://github.com/${VERSION} \
          && dpkg -i /tmp/wkhtmltopdf.deb \
          && rm -f /tmp/wkhtmltopdf.deb; \
        fi \
    7.0:
      command: |
        if [ "$(dpkg-architecture --query DEB_HOST_ARCH)" = "amd64" ]; then \
          DEBIAN_FRONTEND=noninteractive apt-get update -qq \
          && DEBIAN_FRONTEND=noninteractive apt-get install -qq -y --no-install-recommends --no-install-suggests \
            libfontenc1 libxfont1 xfonts-75dpi xfonts-base xfonts-encodings xfonts-utils \
          && curl -sS -L --fail -o /tmp/wkhtmltopdf.deb  https://github.com/${VERSION} \
          && dpkg -i /tmp/wkhtmltopdf.deb \
          && rm -f /tmp/wkhtmltopdf.deb; \
        fi \
    all:
      pre: VERSION="$( curl -sSL -L --fail https://github.com/wkhtmltopdf/wkhtmltopdf/releases | grep -Eo '/wkhtmltopdf/.+stretch_amd64\.deb' | head -1 )"
      command: |
        if [ "$(dpkg-architecture --query DEB_HOST_ARCH)" = "amd64" ]; then \
          DEBIAN_FRONTEND=noninteractive apt-get update -qq \
          && DEBIAN_FRONTEND=noninteractive apt-get install -qq -y --no-install-recommends --no-install-suggests \
            libfontenc1 libxfont2 xfonts-75dpi xfonts-base xfonts-encodings xfonts-utils \
          && curl -sS -L --fail -o /tmp/wkhtmltopdf.deb  https://github.com/${VERSION} \
          && dpkg -i /tmp/wkhtmltopdf.deb \
          && rm -f /tmp/wkhtmltopdf.deb; \
        fi \
      post: |
        if [ "$(dpkg-architecture --query DEB_HOST_ARCH)" = "amd64" ]; then \
          DEBIAN_FRONTEND=noninteractive apt-get purge -qq -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \
          && rm -rf /var/lib/apt/lists/*; \
        fi \
  wpcli:
    disabled: [5.2]
    check: wp --allow-root --version | grep -E '[0-9][.0-9]+'
    5.3:
      command: curl -sS -L --fail https://github.com/wp-cli/wp-cli/releases/download/v1.5.1/wp-cli-1.5.1.phar -L -o /usr/local/bin/wp
      post: chmod +x /usr/local/bin/wp
    5.4:
      command: curl -sS -L --fail https://github.com/wp-cli/wp-cli/releases/download/v2.4.0/wp-cli-2.4.0.phar -L -o /usr/local/bin/wp
      post: chmod +x /usr/local/bin/wp
    5.5:
      command: curl -sS -L --fail https://github.com/wp-cli/wp-cli/releases/download/v2.4.0/wp-cli-2.4.0.phar -L -o /usr/local/bin/wp
      post: chmod +x /usr/local/bin/wp
    all:
      command: curl -sS -L --fail https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar -L -o /usr/local/bin/wp
      post: chmod +x /usr/local/bin/wp
